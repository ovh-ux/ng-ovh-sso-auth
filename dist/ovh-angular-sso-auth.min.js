/*! ovh-angular-sso-auth - 3.1.5 - 2017-09-22 */
angular.module("ovh-angular-sso-auth",["ngCookies"]),angular.module("ovh-angular-sso-auth").provider("ssoAuthentication",function(){"use strict";var a="https://www.ovh.com/auth",b="https://www.ovh.com/auth?action=disconnect",c="/engine/api/me",d=[],e="",f=null;this.setLoginUrl=function(b){a=b},this.setLogoutUrl=function(a){b=a},this.setUserUrl=function(a){c=a},this.setConfig=function(a){d=a},this.setOvhSubsidiary=function(a){f=a};var g=function(g,h,i,j,k){var l=!1,m={"Content-Type":"application/json;charset=utf-8",Accept:"application/json"},n={login:g.defer(),logout:void 0,loginPage:void 0};this.userId=void 0,this.user={},this.getLoginUrl=function(){return a},this.getLogoutUrl=function(){return b},this.getUserUrl=function(){return c},this.getUrlPrefix=function(a){if(!d||!Array.isArray(d)||!d.length)return e;if(a){for(var b=0,c=null;b<d.length&&d[b].serviceType!==a;)b++;return c=d[b],c&&c.hasOwnProperty("urlPrefix")?c.urlPrefix:e}return d[0].urlPrefix},this.isLogged=function(){return n.login.promise.then(function(){return l})},this.getRequestPromise=function(){return this.isLogged().then(function(a){return a?h(function(){return!0},18e5):g.when(!0)})},this.setIsLoggedIn=function(){l=!0,n.login.resolve()},this.sessionCheckOrGoLogin=function(){var a=this;return this.isLogged().then(function(b){return b?void 0:a.goToLoginPage()})},this.getHeaders=function(){return m},this.getUserIdCookie=function(){return"function"==typeof k.get?k.get("USERID"):k.USERID},this.login=function(){var a=this;return $.ajax({url:a.getUserUrl(),method:"GET",headers:m}).done(function(b){a.user=b,l=!0}).fail(function(){l=!1}).always(function(){a.userId=a.getUserIdCookie(),n.login.resolve()}),n.login.promise},this.handleSwitchSession=function(){return j.location.reload(),g.defer().promise},this.getSsoAuthPendingPromise=function(){var a=this;return n.login.promise.then(function(){var b=a.getUserIdCookie();return a.userId!==b?a.handleSwitchSession(b):void 0})},this.logout=function(a){return n.logout||(n.logout=g.defer(),l=!1,h(function(){j.location.assign(b+(b.indexOf("onsuccess")>-1?"":(b.indexOf("?")>-1?"&":"?")+"onsuccess="+encodeURIComponent(a||i.absUrl())))},0)),n.logout.promise},this.goToLoginPage=function(b){return n.loginPage||(n.loginPage=g.defer(),h(function(){var c=[];f&&c.push("ovhSubsidiary="+f),-1===a.indexOf("onsuccess")&&c.push("onsuccess="+encodeURIComponent(b||i.absUrl())),j.location.assign(a+(a.indexOf("?")>-1?"&":"?")+c.join("&"))},0)),n.loginPage.promise}};this.$get=["$q","$timeout","$location","$window","$cookies",function(a,b,c,d,e){return new g(a,b,c,d,e)}]}),angular.module("ovh-angular-sso-auth").factory("ssoAuthInterceptor",["$q","ssoAuthentication",function(a,b){"use strict";return{request:function(c){var d=b.getUrlPrefix(c.serviceType),e=new RegExp(/(?:(?:\.html)|(?:Messages\w+\.json))$/i).test(c.url);return e?c:b.getSsoAuthPendingPromise().then(function(){if(c.headers=angular.extend(angular.copy(b.getHeaders()),c.headers),d&&!/^http(?:s)?:\/\//.test(c.url)&&(c.url=d+c.url),c.timeout){var e=a.defer();c.timeout.then(function(){e.resolve()}),c.noAuthenticate||b.getRequestPromise().then(function(){e.resolve()}),c.timeout=e.promise}else c.noAuthenticate||(c.timeout=b.getRequestPromise());return c})},responseError:function(c){return b.isLogged().then(function(d){return 403!==c.status||"This session is forbidden"!==c.data.message&&"This session is invalid"!==c.data.message||(c.status=401),401!==c.status||c.config.preventLogout?471===c.status?(b.goToLoginPage(),a.reject(c)):c.config&&c.config.noAuthenticate||d?a.reject(c):(b.logout(),a.reject(c)):(b.logout(),a.reject(c))})}}}]);